<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pions Invoice Generator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
/* ---------------------------------------------------- */
/* INDUSTRIAL-GRADE PROFESSIONAL CSS - ALIGNMENT FIX    */
/* ---------------------------------------------------- */

:root {
    --accent-color: #a83c20;      /* Darker, richer red-orange */
    --secondary-color: #4c4c4c;   /* Charcoal text */
    --background-color: #f8f9fa;  /* Light gray background */
    --form-background: #ffffff;   /* White form background */
    --border-color: #e0e0e0;      /* Light gray borders */
    --header-background: #f4f5f6; /* Slightly darker header */
    --box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); /* More prominent shadow */
    --transition-speed: 0.3s;
}

/* Base styles */
body {
    font-family: 'Poppins', Arial, sans-serif;
    background-color: var(--background-color);
    color: var(--secondary-color);
    margin: 0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    line-height: 1.6;
}

/* Header layout */
header {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    padding: 20px 30px;
    background-color: var(--header-background);
    border-bottom: 1px solid var(--border-color);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    position: relative; /* Add this to position the button relative to the header */
}
header img {
    height: 65px;
    margin-right: 20px;
}
header h2 {
    color: var(--accent-color);
    font-style: italic;
    font-size: 2.5em;
    font-weight: 600;
    margin: 0;
}

/* New button for the reprint page */
.reprint-btn {
    position: absolute; /* Position the button absolutely within the header */
    right: 30px; /* Aligns to the right */
    top: 50%; /* Centers vertically */
    transform: translateY(-50%); /* Fine-tunes the vertical center */
    background-color: #1a73e8; /* A nice blue color, or choose your own */
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none; /* Important for <a> tags styled as buttons */
    transition: background-color var(--transition-speed);
}
.reprint-btn:hover {
    background-color: #1558b0;
}

/* General h2 rule, kept for potential use elsewhere */
h2 {
    color: var(--accent-color);
    text-align: center;
}

/* Form Container */
form {
    background-color: var(--form-background);
    padding: 30px;
    border-radius: 10px;
    box-shadow: var(--box-shadow);
    width: 95%;
    max-width: 1400px;
    margin: 30px auto;
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    box-sizing: border-box;
}

/* Fieldset Styling */
fieldset {
    border: 1px solid var(--border-color);
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 8px;
    display: grid;
    /* Reduced minmax and gap for tighter alignment */
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px 15px;
    align-items: flex-start; /* Align items to the top of the grid cell */
}
legend {
    font-weight: 600;
    color: var(--accent-color);
    font-size: 1.2em;
    padding: 0 10px;
    margin-left: -10px;
}

label {
    display: block;
    margin: 0;
    /* Smaller font for better fit */
    font-size: 0.85em;
    font-weight: 600;
    color: var(--secondary-color);
    margin-bottom: 3px;
}
input[type="text"], textarea, input[type="number"] {
    width: 100%;
    /* Slightly smaller padding */
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 0.95em; /* Slightly smaller font */
    box-sizing: border-box;
    transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
}
/* New style for disabled inputs */
.disabled-field {
    background-color: #f0f0f0;
    color: #888;
    cursor: not-allowed;
}

input[type="text"]:focus, textarea:focus, input[type="number"]:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(168, 60, 32, 0.2);
}
textarea {
    resize: vertical;
    min-height: 80px;
}

/* Specific layout for address fieldsets */
.address-group {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}
.address-group fieldset {
    flex: 1;
    min-width: 350px;
    margin-bottom: 0;
    display: flex;
    flex-direction: column;
    gap: 10px; /* Reduced gap */
}
.inline-address-details {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    width: 100%;
}
.field-pair {
    flex: 1;
    min-width: 150px;
    display: flex;
    flex-direction: column;
}

/* Table Styling */
table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 15px;
    font-size: 0.9em;
}
th, td {
    border: 1px solid var(--border-color);
    padding: 12px 10px;
    text-align: center;
    vertical-align: top;
    box-sizing: border-box;
}
th {
    background-color: var(--background-color);
    white-space: nowrap;
    font-weight: 600;
    color: var(--secondary-color);
}
td input {
    height: 40px;
    padding: 8px;
    font-size: 0.9em;
}

/* --- MODIFIED COLUMN WIDTHS FOR BETTER SPACING --- */
#items_table th:nth-child(1), #items_table td:nth-child(1) { width: 3%; }
#items_table th:nth-child(2), #items_table td:nth-child(2) { width: 23%; } /* Changed from 20% to 23% */
#items_table th:nth-child(3), #items_table td:nth-child(3) { width: 10%; }
#items_table th:nth-child(4), #items_table td:nth-child(4) { width: 8%; } /* Changed from 11% to 8% */
#items_table th:nth-child(5), #items_table td:nth-child(5) { width: 9%; }
#items_table th:nth-child(6), #items_table td:nth-child(6) { width: 8%; }
#items_table th:nth-child(7), #items_table td:nth-child(7) { width: 8%; }
#items_table th:nth-child(8), #items_table td:nth-child(8) { width: 8%; }
#items_table th:nth-child(9), #items_table td:nth-child(9) { width: 10%; }
#items_table th:nth-child(10), #items_table td:nth-child(10) { width: 13%; }
/* --- END MODIFIED COLUMN WIDTHS --- */

/* Buttons and totals */
button {
    background-color: var(--accent-color);
    color: white;
    border: none;
    padding: 12px 24px;
    margin: 5px;
    cursor: pointer;
    border-radius: 6px;
    font-size: 1em;
    transition: background-color var(--transition-speed), transform 0.1s ease-in-out, box-shadow var(--transition-speed);
    font-weight: 600;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}
button:hover {
    background-color: #92311b;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}
button:active {
    transform: translateY(0);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.actions {
    text-align: right;
    margin-top: 20px;
}

td.action-buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 5px;
    height: 40px;
    box-sizing: border-box;
}
td.action-buttons button {
    padding: 8px 12px;
    font-size: 0.8em;
    font-weight: normal;
    white-space: nowrap;
    flex-shrink: 0;
    line-height: 1;
    margin: 0;
    height: auto;
    box-shadow: none;
}
td.action-buttons button:hover {
    transform: none;
    box-shadow: none;
}

.total-display {
    margin-top: 15px;
    font-weight: 600;
    font-size: 1.1em;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    flex-wrap: nowrap;
    gap: 25px;
    padding: 0 10px;
}
.total-display span {
    white-space: nowrap;
    flex-shrink: 0;
}

/* Responsive adjustments for smaller screens */
@media (max-width: 768px) {
    header {
        flex-direction: column;
        align-items: flex-start;
        padding: 15px;
    }
    header h2 {
        font-size: 1.8em;
        margin-top: 10px;
    }
    form {
        width: 95%;
        padding: 15px;
    }
    fieldset, .address-group {
        grid-template-columns: 1fr;
        display: block;
    }
    .address-group fieldset {
        min-width: unset;
        flex: unset;
    }
    .address-group fieldset, .inline-address-details, .field-pair {
        flex-direction: column;
        gap: 10px;
    }
    .total-display {
        flex-direction: column;
        align-items: flex-end;
        gap: 10px;
    }
    table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        width: 150%;
    }
    table thead, table tbody, table tr {
        display: block;
    }
    table th, table td {
        min-width: 80px;
        width: auto;
    }
    #items_table th:nth-child(2), #items_table td:nth-child(2) { min-width: 150px; }
}
</style>
</head>
<body>
<header>
    <img src="{{ url_for('static', filename='assets/logo.png') }}" alt="Pions Logo">
    <h2>Pions Invoice Generator</h2>
    <a href="/reprint_page" class="reprint-btn">Reprint Invoice</a>
</header>

<form method="post" action="/generate">

<fieldset>
<legend>Invoice Details</legend>

<label for="invoice_no">Invoice No <span style="color:red;">*</span></label>
<input type="text" id="invoice_no" name="invoice_no" placeholder="Enter Invoice Number" required>

<label for="invoice_date">Invoice Date</label>
<input type="text" id="invoice_date" name="invoice_date">

<label for="state">State</label>
<input type="text" id="state" name="state" placeholder="e.g., Maharashtra">

<label for="state_code">State Code</label>
<input type="text" id="state_code" name="state_code" placeholder="e.g., 27">

<label for="delivery_challan_no">Delivery Challan No.</label>
<input type="text" id="delivery_challan_no" name="delivery_challan_no" placeholder="Delivery Challan Number">

<label for="delivery_challan_date">Delivery Challan Date</label>
<input type="text" id="delivery_challan_date" name="delivery_challan_date">

<label for="transport_mode">Transport Mode</label>
<input type="text" id="transport_mode" name="transport_mode" placeholder="e.g., Road, Air, Rail">

<label for="vehicle_no">Vehicle No.</label>
<input type="text" id="vehicle_no" name="vehicle_no" placeholder="Vehicle Registration Number">

<label for="date_of_supply">Date of Supply</label>
<input type="text" id="date_of_supply" name="date_of_supply">

<label for="place_of_supply">Place of Supply</label>
<input type="text" id="place_of_supply" name="place_of_supply" placeholder="City/Region of Supply">

<label for="insurance_policy_no">Insurance Policy No.</label>
<input type="text" id="insurance_policy_no" name="insurance_policy_no" placeholder="Policy Number">

<label for="insurance_policy_date">Insurance Policy Date</label>
<input type="text" id="insurance_policy_date" name="insurance_policy_date">

<label for="vendor_code">Vendor Code</label>
<input type="text" id="vendor_code" name="vendor_code" placeholder="Vendor Code">

<label for="po_no">P.O. No.</label>
<input type="text" id="po_no" name="po_no" placeholder="Purchase Order Number">

<label for="po_date">P.O. Date</label>
<input type="text" id="po_date" name="po_date">
</fieldset>

<div class="address-group">
    <fieldset>
    <legend>Invoiced To</legend>
    <label for="invoiced_to_address">Address</label>
    <textarea id="invoiced_to_address" name="invoiced_to_address" rows="3" placeholder="Full Address"></textarea>

    <div class="inline-address-details">
        <div class="field-pair">
            <label for="invoiced_state">State</label>
            <input type="text" id="invoiced_state" name="invoiced_state" placeholder="State Name">
        </div>
        <div class="field-pair">
            <label for="invoiced_state_code">State Code</label>
            <input type="text" id="invoiced_state_code" name="invoiced_state_code" placeholder="State Code">
        </div>
        <div class="field-pair">
            <label for="invoiced_gstin">GSTIN</label>
            <input type="text" id="invoiced_gstin" name="invoiced_gstin" placeholder="GSTIN Number">
        </div>
    </div>
    </fieldset>

    <fieldset>
    <legend>Consigned To</legend>
    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <input type="checkbox" id="same_as_invoiced" onchange="toggleConsignedToFields()">
        <label for="same_as_invoiced" style="margin-bottom: 0;">Same as Invoiced To</label>
    </div>

    <label for="consigned_to_address">Address</label>
    <textarea id="consigned_to_address" name="consigned_to_address" rows="3" placeholder="Full Address"></textarea>

    <div class="inline-address-details">
        <div class="field-pair">
            <label for="consigned_state">State</label>
            <input type="text" id="consigned_state" name="consigned_state" placeholder="State Name">
        </div>
        <div class="field-pair">
            <label for="consigned_state_code">State Code</label>
            <input type="text" id="consigned_state_code" name="consigned_state_code" placeholder="State Code">
        </div>
        <div class="field-pair">
            <label for="consigned_gstin">GSTIN</label>
            <input type="text" id="consigned_gstin" name="consigned_gstin" placeholder="GSTIN Number">
        </div>
    </div>
    </fieldset>
</div>

<fieldset>
<legend>Invoice Items</legend>
<table id="items_table">
<thead>
<tr>
<th>#</th>
<th>Description</th>
<th>HSN/SAC</th>
<th>Qty</th>
<th>Rate</th>
<th>CGST %</th>
<th>SGST %</th>
<th>IGST %</th>
<th>Total</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
</fieldset>

<fieldset>
    <legend>Amount Details</legend>
    <div class="total-display">
        <span>Taxable: ₹<span id="total_taxable">0.00</span></span>
        <span>CGST: ₹<span id="total_cgst">0.00</span></span>
        <span>SGST: ₹<span id="total_sgst">0.00</span></span>
        <span>IGST: ₹<span id="total_igst">0.00</span></span>
        <span>Total: ₹<span id="total_amount">0.00</span></span>
    </div>
</fieldset>
 <div class="actions">
    <button type="button" onclick="generatePdfAndRefresh()">Generate PDF</button>
    <button type="button" onclick="resetInvoiceCounter()" style="background-color: #6c757d;">Reset Counter</button>
</div>
</form>

<script>
// Helper function to get today's date in DD/MM/YYYY format
function getTodayDateDDMMYYYY() {
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
    const year = today.getFullYear();
    return `${day}/${month}/${year}`;
}

// Helper function to convert DD/MM/YYYY string to YYYY-MM-DD string (for Date object parsing)
function convertDDMMYYYYtoYYYYMMDD(ddmmyyyy) {
    if (!ddmmyyyy) return '';
    const parts = ddmmyyyy.split('/');
    if (parts.length === 3) {
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }
    return ''; // Return empty string if format is invalid
}

// Helper function to parse DD/MM/YYYY string to Date object
function parseDateFromDisplay(ddmmyyyy) {
    const yyyymmdd = convertDDMMYYYYtoYYYYMMDD(ddmmyyyy);
    if (yyyymmdd) {
        const date = new Date(yyyymmdd);
        // Check if the date is valid (e.g., "31/02/2024" would result in an invalid date)
        if (!isNaN(date.getTime())) {
            return date;
        }
    }
    return null; // Return null for invalid or empty dates
}


// Function to calculate financial year
function getFinancialYear(date) {
    const year = date.getFullYear();
    const month = date.getMonth() + 1; // Month is 0-indexed

    if (month >= 4) { // April to December
        return `${year}-${String(year + 1).slice(2)}`;
    } else { // January to March
        return `${year - 1}-${String(year).slice(2)}`;
    }
}

// Function to generate the next invoice number
function getNextInvoiceNumber() {
    const prefix = "PTPL/";
    const today = new Date();
    const currentFY = getFinancialYear(today);

    let lastInvoiceData = JSON.parse(localStorage.getItem('lastInvoiceData')) || {
        financialYear: '',
        serial: 0,
    };

    let newSerial;

    // Check if the financial year has changed or if the counter was reset.
    if (currentFY !== lastInvoiceData.financialYear || lastInvoiceData.serial === 0) {
        newSerial = 1;
    } else {
        newSerial = lastInvoiceData.serial + 1;
    }

    // Format serial number to be 3 digits
    const formattedSerial = String(newSerial).padStart(3, '0');
    const newInvoiceNo = `${prefix}${currentFY}/${formattedSerial}`;

    // Store the new data in localStorage
    localStorage.setItem('lastInvoiceData', JSON.stringify({
        financialYear: currentFY,
        serial: newSerial
    }));

    return newInvoiceNo;
}

// Function to reset the invoice counter
function resetInvoiceCounter() {
    if (confirm("Are you sure you want to reset the invoice counter? This will set the next invoice number to 001.")) {
        localStorage.removeItem('lastInvoiceData');
        alert("Invoice counter has been reset. The next invoice will start with 001.");
    }
}


// Add dynamic item row with calculations
function addItemRow(desc="", hsn="", qty=0, rate=0, cgst=0, sgst=0, igst=0) {
    const tbody = document.querySelector("#items_table tbody");
    const rows = tbody.querySelectorAll("tr");

    // Remove 'Add Item' button from the previously last row, if it exists
    if (rows.length > 0) {
        const lastRowActionCell = rows[rows.length - 1].querySelector('.action-buttons');
        if (lastRowActionCell) {
            const existingAddButton = lastRowActionCell.querySelector('.add-item-btn');
            if (existingAddButton) {
                existingAddButton.remove();
            }
        }
    }

    const row = document.createElement("tr");
    row.innerHTML = `
        <td class="row-number"></td>
        <td><input type="text" name="item_desc[]" value="${desc}"></td>
        <td><input type="text" name="item_hsn[]" value="${hsn}"></td>
        <td><input type="number" step="0.01" name="item_qty[]" value="${qty}" oninput="updateRowTotal(this)"></td>
        <td><input type="number" step="0.01" name="item_rate[]" value="${rate}" oninput="updateRowTotal(this)"></td>
        <td><input type="number" step="0.01" name="item_cgst[]" value="${cgst}" oninput="updateRowTotal(this)"></td>
        <td><input type="number" step="0.01" name="item_sgst[]" value="${sgst}" oninput="updateRowTotal(this)"></td>
        <td><input type="number" step="0.01" name="item_igst[]" value="${igst}" oninput="updateRowTotal(this)"></td>
        <td class="row-total">0.00</td>
        <td class="action-buttons">
            <button type="button" class="add-item-btn" onclick="addItemRow()">Add Item</button>
            <button type="button" class="remove-item-btn" onclick="removeItemRow(this)">Remove</button>
        </td>
    `;
    tbody.appendChild(row);

    updateRowNumbers();
    updateTotals();
}

function removeItemRow(btn) {
    const row = btn.closest("tr");
    const tbody = row.closest("tbody");
    const isLastRow = row === tbody.lastElementChild; // Check if the row being removed is the last one

    row.remove(); // Remove the row

    updateRowNumbers(); // Update row numbers for remaining rows
    updateTotals(); // Recalculate totals

    const remainingRows = tbody.querySelectorAll('tr'); // Get all remaining rows

    // If the removed row was the last one, and there are still rows left,
    // ensure the 'Add Item' button is present on the new last row.
    if (isLastRow && remainingRows.length > 0) {
        const newLastRowActionCell = remainingRows[remainingRows.length - 1].querySelector('.action-buttons');
        if (newLastRowActionCell && !newLastRowActionCell.querySelector('.add-item-btn')) {
            const addButton = document.createElement('button');
            addButton.type = 'button';
            addButton.className = 'add-item-btn';
            addButton.textContent = 'Add Item';
            addButton.onclick = addItemRow;
            newLastRowActionCell.insertBefore(addButton, newLastRowActionCell.firstChild); // Add to the left
        }
    }
    // If all rows are removed, add one default row
    if (remainingRows.length === 0) {
        addItemRow();
    }
}


function updateRowNumbers() {
    const rows = document.querySelectorAll("#items_table tbody tr");
    rows.forEach((r, i) => r.querySelector(".row-number").textContent = i + 1);
}

function updateRowTotal(input) {
    const row = input.closest("tr");
    const qty = parseFloat(row.querySelector('input[name="item_qty[]"]').value) || 0;
    const rate = parseFloat(row.querySelector('input[name="item_rate[]"]').value) || 0;
    const cgst = parseFloat(row.querySelector('input[name="item_cgst[]"]').value) || 0;
    const sgst = parseFloat(row.querySelector('input[name="item_sgst[]"]').value) || 0;
    const igst = parseFloat(row.querySelector('input[name="item_igst[]"]').value) || 0;

    const taxable = qty * rate;
    const total = taxable + (taxable * (cgst + sgst + igst) / 100);
    row.querySelector(".row-total").textContent = total.toFixed(2);

    updateTotals();
}

function updateTotals() {
    let taxable = 0, cgst_total=0, sgst_total=0, igst_total=0;
    document.querySelectorAll("#items_table tbody tr").forEach(row => {
        const q = parseFloat(row.querySelector('input[name="item_qty[]"]').value) || 0;
        const r = parseFloat(row.querySelector('input[name="item_rate[]"]').value) || 0;
        const c = parseFloat(row.querySelector('input[name="item_cgst[]"]').value) || 0;
        const s = parseFloat(row.querySelector('input[name="item_sgst[]"]').value) || 0;
        const i = parseFloat(row.querySelector('input[name="item_igst[]"]').value) || 0;

        const base = q * r;
        taxable += base;
        cgst_total += base * c / 100;
        sgst_total += base * s / 100;
        igst_total += base * i / 100;
    });

    document.getElementById("total_taxable").textContent = taxable.toFixed(2);
    document.getElementById("total_cgst").textContent = cgst_total.toFixed(2);
    document.getElementById("total_sgst").textContent = sgst_total.toFixed(2);
    document.getElementById("total_igst").textContent = igst_total.toFixed(2);
    document.getElementById("total_amount").textContent = (taxable + cgst_total + sgst_total + igst_total).toFixed(2);
}

// Function to handle PDF generation and page refresh
async function generatePdfAndRefresh() {
    const form = document.querySelector('form');

    // Generate and set the new invoice number right before submission
    const newInvoiceNo = getNextInvoiceNumber();
    document.getElementById("invoice_no").value = newInvoiceNo;

    const formData = new FormData(form);

    const sameAsInvoicedCheckbox = document.getElementById("same_as_invoiced");

    // Manually get the values from the invoiced fields
    const invoicedToAddress = document.getElementById("invoiced_to_address").value;
    const invoicedState = document.getElementById("invoiced_state").value;
    const invoicedStateCode = document.getElementById("invoiced_state_code").value;
    const invoicedGstin = document.getElementById("invoiced_gstin").value;

    // If the checkbox is checked, manually set the "Consigned To" data
    if (sameAsInvoicedCheckbox.checked) {
        formData.set('consigned_to_address', invoicedToAddress);
        formData.set('consigned_state', invoicedState);
        formData.set('consigned_state_code', invoicedStateCode);
        formData.set('consigned_gstin', invoicedGstin);
    }

    // Check if the consigned address fields are empty despite the checkbox being unchecked
    if (!sameAsInvoicedCheckbox.checked && !document.getElementById("consigned_to_address").value) {
        formData.set('consigned_to_address', '');
    }

    try {
        const response = await fetch(form.action, {
            method: form.method,
            body: formData,
        });

        if (response.ok) {
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/pdf')) {
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                let invoiceNumberForFilename = newInvoiceNo; // Use the newly generated number
                invoiceNumberForFilename = invoiceNumberForFilename.replace(/\//g, '_');
                a.download = `${invoiceNumberForFilename}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log("PDF generation request sent successfully and download initiated.");
            } else {
                console.warn("Server response was OK, but not a PDF file. Content-Type:", contentType);
                const textResponse = await response.text();
                alert("PDF generated, but unable to download. Server response: " + textResponse.substring(0, 100) + "...");
            }
        } else {
            console.error("PDF generation failed with status:", response.status);
            const errorText = await response.text();
            alert("Error generating PDF: " + errorText);
        }
    } catch (error) {
        console.error("Error during PDF generation fetch:", error);
        alert("An error occurred while trying to generate the PDF. Please check your network connection.");
    } finally {
        location.reload();
    }
}

// Function to toggle the Consigned To fields based on the checkbox state
function toggleConsignedToFields() {
    const checkbox = document.getElementById("same_as_invoiced");

    // Corrected IDs from your HTML
    const invoicedToAddress = document.getElementById("invoiced_to_address");
    const invoicedState = document.getElementById("invoiced_state");
    const invoicedStateCode = document.getElementById("invoiced_state_code");
    const invoicedGstin = document.getElementById("invoiced_gstin");

    // Corrected IDs from your HTML
    const consignedToAddress = document.getElementById("consigned_to_address");
    const consignedState = document.getElementById("consigned_state");
    const consignedStateCode = document.getElementById("consigned_state_code");
    const consignedGstin = document.getElementById("consigned_gstin");

    if (checkbox.checked) {
        // Copy values from "Invoiced To"
        consignedToAddress.value = invoicedToAddress.value;
        consignedState.value = invoicedState.value;
        consignedStateCode.value = invoicedStateCode.value;
        consignedGstin.value = invoicedGstin.value;

        // Disable and add a class for styling
        consignedToAddress.disabled = true;
        consignedState.disabled = true;
        consignedStateCode.disabled = true;
        consignedGstin.disabled = true;
        consignedToAddress.classList.add("disabled-field");
        consignedState.classList.add("disabled-field");
        consignedStateCode.classList.add("disabled-field");
        consignedGstin.classList.add("disabled-field");
    } else {
        // Clear the fields and re-enable them
        consignedToAddress.value = "";
        consignedState.value = "";
        consignedStateCode.value = "";
        consignedGstin.value = "";

        consignedToAddress.disabled = false;
        consignedState.disabled = false;
        consignedStateCode.disabled = false;
        consignedGstin.disabled = false;
        consignedToAddress.classList.remove("disabled-field");
        consignedState.classList.remove("disabled-field");
        consignedStateCode.classList.remove("disabled-field");
        consignedGstin.classList.remove("disabled-field");
    }
}

// Event listeners and initializations on page load
window.addEventListener("DOMContentLoaded", () => {
    // Add one default empty row for invoice items
    addItemRow();

    const todayDDMMYYYY = getTodayDateDDMMYYYY();

    // 1. Set today's date for Invoice Date
    document.getElementById("invoice_date").value = todayDDMMYYYY;

    // 2. Set default State, State Code, Place of Supply
    document.getElementById("state").value = "Maharashtra";
    document.getElementById("state_code").value = "27";
    document.getElementById("place_of_supply").value = "Pune";

    // 3. Set Insurance Policy No. and Date (fixed unless changed)
    document.getElementById("insurance_policy_no").value = "15340021240200000011";
    document.getElementById("insurance_policy_date").value = "24/10/2024"; // Set in DD/MM/YYYY

    // 4. Conditional Date Auto-fill Logic
    const deliveryChallanNoInput = document.getElementById("delivery_challan_no");
    const deliveryChallanDateInput = document.getElementById("delivery_challan_date");
    deliveryChallanNoInput.addEventListener('input', () => {
        if (deliveryChallanNoInput.value.trim() !== '') {
            deliveryChallanDateInput.value = todayDDMMYYYY;
        } else {
            deliveryChallanDateInput.value = '';
        }
    });

    const vehicleNoInput = document.getElementById("vehicle_no");
    const transportModeInput = document.getElementById("transport_mode");
    const dateOfSupplyInput = document.getElementById("date_of_supply");
    const updateDateOfSupply = () => {
        if (vehicleNoInput.value.trim() !== '' || transportModeInput.value.trim() !== '') {
            dateOfSupplyInput.value = todayDDMMYYYY;
        } else {
            dateOfSupplyInput.value = '';
        }
    };
    vehicleNoInput.addEventListener('input', updateDateOfSupply);
    transportModeInput.addEventListener('input', updateDateOfSupply);

    const poNoInput = document.getElementById("po_no");
    const poDateInput = document.getElementById("po_date");
    poNoInput.addEventListener('input', () => {
        if (poNoInput.value.trim() !== '') {
            poDateInput.value = todayDDMMYYYY;
        } else {
            poDateInput.value = '';
        }
    });
});
</script>
</body>
</html>